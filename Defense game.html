<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Defense Game</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script type="text/javascript">
  var Upgrade={
    name:[["엔진가동","스나이퍼","최적화","암살자"],["파괴자","마피아","분쇄자","악마"],["레드코인","비트코인","암시장","비트코인거래소"],["스트라이커","폭파","암흑에너지","대폭발"],["에너지 전환","악의의 탄환","과학타워","마왕"]],
    cost:[[120,140,500,500],[220,260,700,1000],[500,500,1500,2000],[240,400,1500,1200],[500,600,2000,3000]],
    AbilityTarget:[[1,[0,2],[1,2,3],[2,3]],[0,[0,1],[0,1,2],4],[3,3,3,3],[0,3,1,3],[0,[1,3],3,[0,1,2]]],
    AbilityValue:[[-20,[1 ,30],[-20,50,3],[40,5]],[1,[1,-10],[2,-15,50],0],[0,0,0,0],[3,0,-150,0],[2,[-30,5],0,[2,-30,50]]],
    C:[[120,140,500,500],[220,260,700,1000],[500,500,1500,2000],[240,400,1500,1200],[500,600,2000,3000]]
  };
  var effect={
    x:[],
    y:[],
    Fx:[],
    Fy:[],
    type:[],
    value:[],
    Delay:[]
  };
  var bullet_DNA={
    hp:[1,1,0,7,2],
    speed:[4,5,0,3,7],
    size:[10,8,0,18,7]
  }
  var bullet={
    hp:[],
    x:[],
    y:[],
    D:[],
    type:[],
    TargetLocation:[],
    target:[],
    speed:[],
    size:[],
    upgrade:[],
    master:[],
    temp:[]
  }
  var enemy_DNA={
    hp:[1,2,3,4,5,6],
    speed:[1,1.1,1.2,2,2.1,2.5],
    shape:[0,0,0,0,0,0], //0:원,1:사각형
    size:[15,15,15,15,20,20],
    cost:[1,2,3,4,6,7,8]
  };
  var tower_DNA={
    R:[150,100,50,100,210],
    cost:[120,300,1000,240,500],
    Delay:[80,40,10000,250,80],
    name:["기본타워","게틀링타워","은행","메가탄타워","유도탄타워"],
    C:[120,300,1000,240,500]
  };
  var enemy={
    hp:[],
    type:[],
    D:[],
    point:[],
    point_Saver:[],
    x:[],
    y:[],
    cost:[]
  };
  var tower={
    type:[],
    Upgrade:[],
    D:[],
    R:[],
    AttackDelay:[],
    x:[],
    y:[],
    AddBhp:[],
    AddADelay:[],
    AddSpeed:[],
    cost:[]
  };
  var map_DNA={
    start:[500,500,325,500,500],
    point:[[115,400,115,400,115,400,115,400,115,480],[220,400,220,400,220,480],[750],[115,400,115,400,115,400,115,400,115,480],[115,400,115,400,115,400,115,400,115,480]],
    Devent:[[90,0,90,180,90,0,90,180,90,0],[90,0,90,180,90,0],[90],[90,0,90,180,90,0,90,180,90,0],[90,0,90,180,90,0,90,180,90,0]],
  };
  var map={
    start:500,
    point:[115,400,115,400,115,400,115,400,115,420],
    Devent:[90,0,90,180,90,0,90,180,90,0],
    pointLocationSaver:[]
  };
  var mouse={
    x:0,
    y:0,
    click:0
  };
  var Difficulty=0;
  var explain=0;
  var SelectedMap=0;
  var TowerTapEvent=0;
  var fastmod=0;
  var Round_DNA=[[50,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[50,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[30,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[30,4,4,4,4,4,4,4,4],[30,5,5,5]];
  var Round=0;
  var Round_summon=1;
  var OnRound=0;
  var EnemySummon=0;
  var money=50000;
  var Situation=0;
  var Timer=0;
  var HP=100;
  var Select=-1;
  var ESC=0;
  var SPACE=0;
  var POP=0;
  var ONE=0;
  var page=0;
  var MoneyRand=0;
  var heartIMG = new Image();
  var SelectedTower=-1;
  window.addEventListener('mousemove',function(e){
    mouse.x=e.x;
    mouse.y=e.y;
  });
  $(document).click(function (evt) {
    mouse.click=1;
  })
  $(document).keydown(function(e) {
    if (e.keyCode==27) {
      ESC=1;
    }else if (e.keyCode==32) {
      SPACE=1;
    }
  }).keyup(function(e) {
    if (e.keyCode==27) {
      ESC=0;
    }else if (e.keyCode==32) {
      SPACE=0;
    }
  });
  function draw(){
    var canvas = document.getElementById("MAIN");
    if(canvas.getContext){
      var ctx = canvas.getContext("2d");
      BG();
      switch (Situation) {
        case 0:
          Start();
          break;
        case 1:
          Timer+=1;
          EnemySummon+=1+fastmod;
          DrawPath();
          InGame();
          for (var i = 0; i < tower.AttackDelay.length; i++) {
            if (tower.AttackDelay[i]!=0) {
              tower.AttackDelay[i]-=1+fastmod;
            }
          }
          break;
        case 2:
          DifficultyList();
          break;
        case 3:
          MapList();
          break;
      }
      requestAnimationFrame(draw);
    }
    mouse.click=0;
  }
  function DrawTower(type,upgrade,x,y,size,direction){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.beginPath();
    ctx.fillStyle="#606060";
    ctx.fillRect(x-size/2,y-size/2,size,size);
    ctx.stroke();
    ctx.beginPath();
    ctx.lineWidth=3*(size/50);
    ctx.strokeStyle="#202020";
    ctx.rect(x-size/2,y-size/2,size,size);
    ctx.stroke();
    switch(type){
      case 0:
        if (upgrade[0]>=2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#606060";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if(upgrade[1]>=2){
          ctx.strokeStyle="#202020";
          ctx.lineWidth=1;
          ctx.fillStyle = "#D00000";
          ctx.beginPath();
          ctx.rect(x-size/2,y-size/4,size,size/2);
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10+size/10*upgrade[1]),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10+size/10*upgrade[1]));
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#868e96";
        ctx.lineWidth=size/2-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)+size/10*upgrade[1]),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)+size/10*upgrade[1]));
        ctx.stroke();
        ctx.lineWidth=3*(size/50);
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        if(upgrade[1]>=1){
          ctx.fillStyle = "#D00000";
        }else{
          ctx.fillStyle = "#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        if (upgrade[0]>=1) {
          DrawGear(Timer,x,y,size/1.5,);
        }
        break;
      case 1:
        Size=size/10;
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-Size/2;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size-Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/15)-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/15)-Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(Size/2);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size+Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/15)+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/15)+Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#D0D000";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-Size;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size-Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10)-Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/10)-Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#D0D000";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-(Size);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*Size+Math.sin(Math.PI/180*direction)*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10)+Math.cos(Math.PI/180*direction)*Size,y+Math.sin(Math.PI/180*(direction-90))*(size-size/10)+Math.sin(Math.PI/180*direction)*Size);
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-size/15;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*Size,y+Math.sin(Math.PI/180*(direction-90))*Size);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*size*1,y+Math.sin(Math.PI/180*(direction-90))*size*1);
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[0]>=2){
          ctx.strokeStyle="#FFFF00";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/2-8*size/50;
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-90))*size/5,y+Math.sin(Math.PI/180*(direction-90))*size/5);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size*1-(-size/15+8*size/50)/2),y+Math.sin(Math.PI/180*(direction-90))*(size*1-(-size/15+8*size/50)/2));
        ctx.stroke();
        if (upgrade[0]>=1) {
          DrawGear(direction,move(direction+180,x,y,size/3)[0],move(direction+180,x,y,size/3)[1],size/2,)
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        if (upgrade[1]==1) {
          ctx.fillStyle = "#202020";
        }else if(upgrade[1]==2){
          ctx.fillStyle = "#D00000";
        }else{
          ctx.fillStyle = "#6060FF";
        }
        ctx.lineWidth=3*(size/50);
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction-45))*size/2,y+Math.sin(Math.PI/180*(direction-45))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+45))*size/2,y+Math.sin(Math.PI/180*(direction+45))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+135))*size/2,y+Math.sin(Math.PI/180*(direction+135))*size/2);
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x+Math.cos(Math.PI/180*(direction+135))*size/2,y+Math.sin(Math.PI/180*(direction+135))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+225))*size/2,y+Math.sin(Math.PI/180*(direction+225))*size/2);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction+315))*size/2,y+Math.sin(Math.PI/180*(direction+315))*size/2);
        ctx.fill();
        ctx.stroke();
        if (upgrade[0]>=1) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction,x,y,size*2/8)[0],move(direction,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.fillStyle="#FFFF00";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.stroke();
        }
        break;
      case 2:
        ctx.lineWidth=3*(size/50);
        if (upgrade[1]>=2) {
          DrawGear(Timer,x-size/2,y,size/1.5,);
          DrawGear(Timer,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#606060";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[0]>=2) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        if (upgrade[0]==2) {
          ctx.beginPath();
          ctx.fillStyle = "#D80000";
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/4,size,size/2);
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        if (upgrade[0]==0) {
          ctx.fillStyle = "#FFFF00";
        }else if(upgrade[0]==1){
          ctx.fillStyle = "#D80000";
        }else{
          ctx.fillStyle = "#FFFFFF";
        }
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        ctx.font = 30*size/40+"px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if (upgrade[1]==0) {
          ctx.fillText("$",x,y+size/2-(10*size/50));
        }else{
          ctx.fillText("B",x,y+size/2-(10*size/50));
          ctx.beginPath();
          ctx.moveTo(x,y-size/2+(10*size/50));
          ctx.lineTo(x,y+size/2-(7*size/50));
          ctx.stroke();
        }
        break;
      case 3:
        if (upgrade[0]==2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          ctx.fillStyle="#000000";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#800000";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/1.25-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10));
        ctx.stroke();
        ctx.beginPath();
        if(upgrade[1]==2){
          ctx.strokeStyle="#DFFF00";
        }else{
          ctx.strokeStyle="#868e96";
        }
        ctx.lineWidth=size/1.25-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)));
        ctx.stroke();
        ctx.lineWidth=3*(size/50);
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(5*size/50),0,Math.PI * 2);
        if(upgrade[0]>=1){
          ctx.fillStyle="#800000";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.arc(x,y,size/2-(10*size/50),0,Math.PI * 2);
        if(upgrade[0]>=1){
          ctx.fillStyle="#FFFF00";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.strokeStyle="#202020";
        if(upgrade[1]>=1){
          ctx.lineWidth=3*(size/50);
          for(var i=0;i<6;i++){
            ctx.beginPath();
            ctx.moveTo(move(direction-30+60*i,x,y,size/8)[0],move(direction-30+60*i,x,y,size/8)[1]);
            ctx.lineTo(move(direction+60*i,x,y,size/4)[0],move(direction+60*i,x,y,size/4)[1]);
            ctx.lineTo(move(direction+30+60*i,x,y,size/8)[0],move(direction+30+60*i,x,y,size/8)[1]);
            ctx.stroke();
          }
          if (upgrade[1]==2) {
            ctx.lineWidth=size/50;
            for(var i=0;i<6;i++){
              ctx.beginPath();
              ctx.moveTo(move(direction-30+60*i,x,y,size/16)[0],move(direction-30+60*i,x,y,size/16)[1]);
              ctx.lineTo(move(direction+60*i,x,y,size/8)[0],move(direction+60*i,x,y,size/8)[1]);
              ctx.lineTo(move(direction+30+60*i,x,y,size/16)[0],move(direction+30+60*i,x,y,size/16)[1]);
              ctx.stroke();
            }
            ctx.lineWidth=size/50;
            for(var i=0;i<6;i++){
              ctx.beginPath();
              ctx.moveTo(move(direction-30+60*i,x,y,size/32)[0],move(direction-30+60*i,x,y,size/32)[1]);
              ctx.lineTo(move(direction+60*i,x,y,size/16)[0],move(direction+60*i,x,y,size/16)[1]);
              ctx.lineTo(move(direction+30+60*i,x,y,size/32)[0],move(direction+30+60*i,x,y,size/32)[1]);
              ctx.stroke();
            }
          }
        }
        break;
      case 4:
        if (upgrade[1]>=1) {
          ctx.beginPath();
          ctx.fillStyle="#202020";
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
        }
        if (upgrade[0]>=2) {
          DrawGear(direction,x-size/2,y,size/1.5,);
          DrawGear(direction,x+size/2,y,size/1.5,);
          ctx.beginPath();
          if(upgrade[1]==0){
            ctx.fillStyle="#606060";
          }else {
            ctx.fillStyle="#202020";
          }
          ctx.fillRect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.strokeStyle="#202020";
          ctx.rect(x-size/2,y-size/2,size,size);
          ctx.stroke();
          ctx.beginPath();
          if (upgrade[1]>=2) {
            ctx.fillStyle="#FFFF00";
          }else{
            ctx.fillStyle="#20FF20";
          }
          ctx.fillRect(x-size/3,y-size/3,size/1.5,size/1.5);
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=3*(size/50);
          ctx.rect(x-size/3,y-size/3,size/1.5,size/1.5);
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.lineWidth=size/2-(size/10);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*(size-size/10),y+Math.sin(Math.PI/180*(direction-90))*(size-size/10));
        ctx.stroke();
        ctx.beginPath();
        ctx.strokeStyle="#868e96";
        ctx.lineWidth=size/2-(size/5);
        ctx.moveTo(x,y);
        ctx.lineTo(x+Math.cos(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)),y+Math.sin(Math.PI/180*(direction-90))*((size-size/10)-3*(size/50)));
        ctx.stroke();
        if (upgrade[1]>=2) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-45,x,y,size*4/8)[0],move(direction-45,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
          ctx.fillStyle="#D00000";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction+45,x,y,size*4/8)[0],move(direction+45,x,y,size*4/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
          ctx.fillStyle="#D00000";
          ctx.fill();
          ctx.stroke();
        }
        ctx.beginPath();
        ctx.lineWidth=size/20;
        ctx.strokeStyle="#202020";
        ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction,x,y,size*4/8)[0],move(direction,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
        if (upgrade[1]>=2) {
          ctx.fillStyle="#D00000";
        }else{
          ctx.fillStyle="#6060FF";
        }
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(move(direction+120,x,y,size*4/8)[0],move(direction+120,x,y,size*4/8)[1]);
        ctx.lineTo(move(direction-120,x,y,size*4/8)[0],move(direction-120,x,y,size*4/8)[1]);
        ctx.stroke();
        if (upgrade[0]>=1) {
          ctx.beginPath();
          ctx.lineWidth=size/20;
          ctx.strokeStyle="#202020";
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction,x,y,size*2/8)[0],move(direction,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.fillStyle="#FFFF00";
          ctx.fill();
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(move(direction+120,x,y,size*2/8)[0],move(direction+120,x,y,size*2/8)[1]);
          ctx.lineTo(move(direction-120,x,y,size*2/8)[0],move(direction-120,x,y,size*2/8)[1]);
          ctx.stroke();
        }
        break;
    }
  }
  function move(D,StartX,StartY,value){
    return [StartX+Math.cos(Math.PI/180*(D-90))*value,StartY+Math.sin(Math.PI/180*(D-90))*value]
  }
  function DrawPath() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    drawer={
      direction:90,
      x:0,
      y:map.start
    };
    ctx.lineWidth=40;
    ctx.strokeStyle="#868e96";
    ctx.beginPath();
    ctx.strokeStyle="#868e96";
    ctx.moveTo(0,drawer.y);
    ctx.stroke();
    map.pointLocationSaver=[];
    for (var i = 0; i < map.point.length; i++) {
      ctx.beginPath();
      drawer.direction=map.Devent[i];
      map.pointLocationSaver.push([drawer.x,drawer.y]);
      if(drawer.direction==0){
        ctx.moveTo(drawer.x,drawer.y+ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y-ctx.lineWidth/2+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==90) {
        ctx.moveTo(drawer.x-ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x+ctx.lineWidth/2+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==180) {
        ctx.moveTo(drawer.x,drawer.y-ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+ctx.lineWidth/2+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else if (drawer.direction==270) {
        ctx.moveTo(drawer.x+ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x-ctx.lineWidth/2+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }else{
        ctx.moveTo(drawer.x,drawer.y);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map.Devent[i]-90))*map.point[i];
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map.Devent[i]-90))*map.point[i];
      }
      ctx.lineTo(drawer.x,drawer.y);
      ctx.stroke();
    }
    map.pointLocationSaver.push([drawer.x,drawer.y]);
  }
  function BG(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = "#62911A";
    ctx.fillRect(0,0,1000,650);
  }
  function Start(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.fillStyle = "#FFFFFF";
    ctx.font = "100px Arial";
    ctx.textAlign = "left";
    ctx.fillText("Defense Game", 200, 150);
    ctx.fillStyle = "#FFFFFF";
    ctx.fillRect(300,275,400,100);
    ctx.font = "75px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "left";
    ctx.fillText("START", 375, 350);
    if (307<=mouse.x&&mouse.x<=707&&285<=mouse.y&&mouse.y<=385&&mouse.click) {
      Situation=2;
      requestAnimationFrame(draw);
    }
  }
  function InGame(){
    if(OnRound==1&&Round<Round_DNA.length){
      if (Round_DNA[Round][0]==0) {
        while (Round_DNA[Round].length>Round_summon) {
          MakeEnemy(Round_DNA[Round][Round_summon]);
          Round_summon+=1;
        }
      }
      if (EnemySummon>=Round_DNA[Round][0]&&Round_DNA[Round].length>Round_summon) {
        MakeEnemy(Round_DNA[Round][Round_summon]);
        Round_summon+=1;
        EnemySummon=0;
      }
      if (enemy.x.length==0&&Round_DNA[Round].length<=Round_summon&&ONE==0) { //라운드가 끝날때 1번 실행됨.
        for (var i = 0; i < tower.x.length; i++) {
          if (tower.type[i]==2) {
            if (tower.Upgrade[i][1]==0) {
              MakeEffect(tower.x[i],tower.y[i],0,100);
              money+=100;
            }else if(tower.Upgrade[i][1]==1){
              MoneyRand=Rand(1,150,200);
              MakeEffect(tower.x[i],tower.y[i],0,MoneyRand);
              money+=MoneyRand;
            }else if(tower.Upgrade[i][1]==2){
              MoneyRand=Rand(1,300,500);
              MakeEffect(tower.x[i],tower.y[i],0,MoneyRand);
              money+=MoneyRand;
            }
          }
        }
        for (var i = 0; i < bullet.type.length; i++) {
          bullet.hp.splice(i,1);
          bullet.x.splice(i,1);
          bullet.y.splice(i,1);
          bullet.D.splice(i,1);
          bullet.type.splice(i,1);
          bullet.TargetLocation.splice(i,1);
          bullet.target.splice(i,1);
          bullet.size.splice(i,1);
          bullet.master.splice(i,1);
          bullet.upgrade.splice(i,1);
          bullet.temp.splice(i,1);
        }
        ONE=1;
      }
      if (enemy.x.length==0&&Round_DNA[Round].length<=Round_summon) {
        money+=POP;
        OnRound=0;
        POP=0;
        Round+=1;
      }
    }else {
      EnemySummon=0;
      Round_summon=1;
    }
    MoveEnemy();
    DrawEnemy();
    ShowBullet();
    DrawEveryTower();
    DrawTap(Select);
    ActiveTower();
    ActiveBullet();
    if (Select==-1) {
      TowerClick();
      if (SelectedTower!=-1) {
        var ctx = document.getElementById("MAIN").getContext("2d");
        ctx.fillStyle = 'rgba(20,20, 20, 0.5)';
        ctx.beginPath();
        ctx.strokeStyle="rgba(20,20,20,0.0)";
        ctx.arc(tower.x[SelectedTower],tower.y[SelectedTower],tower.R[SelectedTower],0,Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        DrawTower(tower.type[SelectedTower],tower.Upgrade[SelectedTower],tower.x[SelectedTower],tower.y[SelectedTower],40,tower.D[SelectedTower]);
        TowerTapClick(SelectedTower,mouse.click);
        DrawTowerTap(SelectedTower);
      }
      if (mouse.click) {
        ClickTower();
      }
    }else{
      SelectedTower=-1;
      var ctx = document.getElementById("MAIN").getContext("2d");
      if (!IsTowerColliseWithPath()&&document.getElementById("MAIN").width*3/4-20>=mouse.x&&mouse.y+20<=document.getElementById("MAIN").height&&mouse.y-20>=0&&20<=mouse.x) {
        ctx.fillStyle = 'rgba(20, 0, 0, 0.5)';
      }else {
        ctx.fillStyle = 'rgba(255,20, 20, 0.5)';
      }
      ctx.beginPath();
      ctx.strokeStyle="rgba(20,20,20,0.0)";
      ctx.arc(mouse.x,mouse.y,tower_DNA.R[Select],0,Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      DrawTower(Select,[0,0],mouse.x,mouse.y,40,0);
      if (ESC==1) {
        Select=-1;
      }
      if (mouse.click){
        if(document.getElementById("MAIN").width*3/4>mouse.x&&!IsTowerColliseWithPath()&&document.getElementById("MAIN").width*3/4-20>=mouse.x&&mouse.y+20<=document.getElementById("MAIN").height&&mouse.y-20>=0&&20<=mouse.x){
          tower.type.push(Select);
          tower.Upgrade.push([0,0]);
          tower.x.push(mouse.x);
          tower.y.push(mouse.y);
          tower.D.push(0);
          tower.R.push(tower_DNA.R[Select]);
          tower.AttackDelay.push(0);
          tower.AddBhp.push(0);
          tower.AddADelay.push(0);
          tower.AddSpeed.push(0);
          tower.cost.push(tower_DNA.cost[Select]);
          money-=tower_DNA.cost[Select];
          Select=-1;
        }else if (document.getElementById("MAIN").width*3/4<=mouse.x) {
          Select=-1;
        }
      }
    }
    ActiveEffect();
  }
  function MakeTower(type,x,y,upgrade,d) {
    tower.type.push(type);
    tower.Upgrade.push(upgrade);
    tower.x.push(x);
    tower.y.push(y);
    tower.D.push(d);
    tower.R.push(tower_DNA.R[type]);
    tower.AddBhp.push(0);
    tower.AddADelay.push(0);
    tower.AttackDelay.push(0);
    tower.cost.push(tower_DNA.cost[type]);
  }
  function ActiveTower() {
    for (var i = 0; i < tower.type.length; i++) {
      target=-1;
      for (var j = enemy.x.length; j >=0; --j) {
        if (IsRangeInRange(i,j)) {
          target=j;
        }
      }
      if (target!=-1) {
        tower.D[i]=AngleOfTwoPoint([tower.x[i],tower.y[i]],[enemy.x[target],enemy.y[target]]);
        Shot(i);
      }
    }
  }
  function Shot(TowerNum){
    target=-1;
    for (var j = enemy.x.length; j >=0; --j) {
      if (IsRangeInRange(TowerNum,j)) {
        target=j;
      }
    }
    if (target!=-1&&tower.AttackDelay[TowerNum]<=0) {
      bullet.hp.push(bullet_DNA.hp[tower.type[TowerNum]]+tower.AddBhp[TowerNum]);
      bullet.x.push(tower.x[TowerNum]);
      bullet.y.push(tower.y[TowerNum]);
      bullet.D.push(tower.D[TowerNum]);
      bullet.type.push(tower.type[TowerNum]);
      bullet.TargetLocation.push([enemy.x[target],enemy.y[target]]);
      bullet.target.push(target);
      bullet.speed.push(bullet_DNA.speed[tower.type[TowerNum]]+tower.AddSpeed[TowerNum]);
      bullet.size.push(bullet_DNA.size[tower.type[TowerNum]]);
      bullet.master.push(TowerNum);
      bullet.upgrade.push(tower.Upgrade[TowerNum]);
      bullet.temp.push(0);
      if (tower.type[TowerNum]==4&&tower.Upgrade[TowerNum][0]==2) {
        bullet.hp.push(bullet_DNA.hp[tower.type[TowerNum]]+tower.AddBhp[TowerNum]);
        bullet.x.push(tower.x[TowerNum]);
        bullet.y.push(tower.y[TowerNum]);
        bullet.D.push(tower.D[TowerNum]);
        bullet.type.push(tower.type[TowerNum]);
        bullet.TargetLocation.push([enemy.x[target],enemy.y[target]]);
        bullet.target.push(target);
        bullet.speed.push(bullet_DNA.speed[tower.type[TowerNum]]+tower.AddSpeed[TowerNum]);
        bullet.size.push(bullet_DNA.size[tower.type[TowerNum]]);
        bullet.master.push(TowerNum);
        bullet.upgrade.push(tower.Upgrade[TowerNum]);
        bullet.temp.push(0);
      }
      tower.AttackDelay[TowerNum]=tower_DNA.Delay[tower.type[TowerNum]]+tower.AddADelay[TowerNum];
    }
  }
  function ActiveBullet() {
    for (var i = 0; i < bullet.x.length; i++) {
      touch=-1;
      if (isNaN(bullet.D[i])||isNaN(bullet.x[i])||isNaN(bullet.y[i])) {
        bullet.hp.splice(i,1);
        bullet.x.splice(i,1);
        bullet.y.splice(i,1);
        bullet.D.splice(i,1);
        bullet.type.splice(i,1);
        bullet.TargetLocation.splice(i,1);
        bullet.target.splice(i,1);
        bullet.speed.splice(i,1);
        bullet.size.splice(i,1);
        bullet.master.splice(i,1);
        bullet.upgrade.splice(i,1);
        bullet.temp.splice(i,1);
      }
      for (var j = 0; j < enemy.x.length; j++) {
        switch (enemy_DNA.shape[enemy.type[j]]) {
          case 0:
          if(Ccollision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],bullet.size[i],enemy_DNA.size[enemy.type[j]])){
            touch=j;
          }
          break;
          case 1:
          if(collision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],bullet.size[j],enemy_DNA.size[enemy.type[j]])){
            touch=j;
          }
          break;
        }
      }
      if (touch!=-1) {
        if (enemy.hp[touch]<=bullet.hp[i]) {
          bullet.hp[i]-=enemy.hp[touch];
          enemy.hp[touch]=0;
        }else if(enemy.hp[touch]>bullet.hp[i]){
          enemy.hp[touch]-=bullet.hp[i];
          bullet.hp[i]=0;
        }else{
          enemy.hp[touch]-=1;
          bullet.hp[i]-=1;
        }
        if (enemy.hp[touch]!=0) {
          enemy.type[touch]-=1;
        }else if (bullet.type[i]==4 && enemy.type.length!=0) {
          touch=-1;
          for (var j = 0; j < enemy.x.length; j++) {
            switch (enemy_DNA.shape[enemy.type[j]]) {
              case 0:
              if(Ccollision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],50,enemy_DNA.size[enemy.type[j]])){
                touch=j;
              }
              break;
              case 1:
              if(collision(bullet.x[i],bullet.y[i],enemy.x[j],enemy.y[j],50,enemy_DNA.size[enemy.type[j]])){
                touch=j;
              }
              break;
            }
          }
          if(touch!=-1){
            bullet.target[i]=touch;
          }else{
            bullet.hp[i]=0;
          }
        }
        if(enemy.hp[touch]==0){
          for (var j = 0; j < tower.type.length; j++) {
            if (tower.type[j]==2){
              if(tower.Upgrade[j][0]==1) {
                MakeEffect(tower.x[j],tower.y[j],1,enemy.cost[touch]);
                money+=enemy_DNA.cost[touch];
              }else if(tower.Upgrade[j][0]==2){
                MakeEffect(tower.x[j],tower.y[j],1,enemy.cost[touch]*10);
                money+=enemy_DNA.cost[touch]*10;
              }
            }
          }
        }
      }
      if(bullet.type[i]==4&&bullet.x.length!=0){
        if (isNaN(AngleOfTwoPoint([bullet.x[i],bullet.y[i]],[enemy.x[bullet.target[i]],enemy.y[bullet.target[i]]]))) {
          bullet.hp[i]=0;
        }else{
          bullet.D[i]=AngleOfTwoPoint([bullet.x[i],bullet.y[i]],[enemy.x[bullet.target[i]],enemy.y[bullet.target[i]]]);
        }
      }
      if(bullet.type[i]!=-1){
        if (IsPointInCircle(bullet.x[i],bullet.y[i],bullet.size[i],bullet.TargetLocation[i][0],bullet.TargetLocation[i][1])&&bullet.type[i]==3&&bullet.upgrade[i][1]>=1&&bullet.temp==0) {
          for (var j = 0; j < 4*bullet.upgrade[i][1]; j++) {
            MakeBullet(j*45*(3-bullet.upgrade[i][1]),bullet.x[i],bullet.y[i],10,1,10);
          }
          bullet.temp[i]=1;
        }
      }
      if (bullet.hp[i]<=0||bullet.x[i]<=0||bullet.y[i]<=0||bullet.x[i]>=document.getElementById("MAIN").width||bullet.y[i]>=document.getElementById("MAIN").height) {
        bullet.hp.splice(i,1);
        bullet.x.splice(i,1);
        bullet.y.splice(i,1);
        bullet.D.splice(i,1);
        bullet.type.splice(i,1);
        bullet.TargetLocation.splice(i,1);
        bullet.target.splice(i,1);
        bullet.speed.splice(i,1);
        bullet.size.splice(i,1);
        bullet.master.splice(i,1);
        bullet.upgrade.splice(i,1);
        bullet.temp.splice(i,1);
      }else{
        bullet.x[i]+=Math.cos(Math.PI/180*(bullet.D[i]-90))*(bullet.speed[i]+bullet.speed[i]*fastmod);
        bullet.y[i]+=Math.sin(Math.PI/180*(bullet.D[i]-90))*(bullet.speed[i]+bullet.speed[i]*fastmod);
      }
    }
  }
  function ShowBullet() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < bullet.x.length; i++) {
      ctx.beginPath();
      ctx.strokeStyle="#202020";
      ctx.fillStyle = "#6060FF";
      ctx.lineWidth = 1;
      ctx.arc(bullet.x[i],bullet.y[i],bullet.size[i],0,Math.PI * 2);
      ctx.fill();
      ctx.stroke();
    }
  }
  function ClickTower() {
    click=-1;
    for (var i = 0; i < tower.x.length; i++) {
      if (tower.x[i]-20<=mouse.x&&mouse.x<=tower.x[i]+20&&mouse.y<=tower.y[i]+20&&mouse.y>=tower.y[i]-20) {
        click=i;
      }
    }
    if(!(85<=mouse.x&&mouse.x<=690&&mouse.y>=455&&SelectedTower!=-1)){
      SelectedTower=click;
    }
  }
  function IsRangeInRange(TowerNum,EnemyNum) {
    switch (enemy_DNA.shape[enemy.type[EnemyNum]]) {
      case 0:
      if(Ccollision(tower.x[TowerNum],tower.y[TowerNum],enemy.x[EnemyNum],enemy.y[EnemyNum],tower.R[TowerNum],enemy_DNA.size[enemy.type[EnemyNum]])){
        return 1;
      }
      break;
      case 1:
      if(collision(tower.x[TowerNum],tower.y[TowerNum],enemy.x[EnemyNum],enemy.y[EnemyNum],tower.R[TowerNum],enemy_DNA.size[enemy.type[EnemyNum]])){
        return 1;
      }
      break;
    }
    return 0;
  }
  function AngleOfTwoPoint([ax,ay],[bx,by]) {
    return Math.atan2(by-ay,bx-ax)*180/Math.PI+90;
  }
  function DrawEveryTower() {
    for (var i = 0; i < tower.type.length; i++) {
      DrawTower(tower.type[i],tower.Upgrade[i],tower.x[i],tower.y[i],40,tower.D[i]);
    }
  }
  function IsTowerColliseWithPath() {
    for (var i = 0; i < map.pointLocationSaver.length-1; i++) {
      if (Rcollision([mouse.x-20,mouse.y-20,mouse.x+20,mouse.y+20],[map.pointLocationSaver[i][0]-20,map.pointLocationSaver[i][1]-20,map.pointLocationSaver[i+1][0]+20,map.pointLocationSaver[i+1][1]+20*(map.Devent[i]==90||map.Devent[i]==270)-20*(map.Devent[i]==180||map.Devent[i]==0)])) {
        return 1;
      }
    }
    for (var i = 0; i < tower.x.length; i++) {
      if (Rcollision([mouse.x-20,mouse.y-20,mouse.x+20,mouse.y+20],[tower.x[i]-20,tower.y[i]-20,tower.x[i]+20,tower.y[i]+20])) {
        return 1;
      }
    }
    return 0;
  }
  function DrawEnemy(){
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < enemy.x.length; i++) {
      ctx.beginPath();
      switch (enemy.type[i]) {
        case 0:
        ctx.fillStyle = "#FF0000";
        break;
        case 1:
        ctx.fillStyle = "#FF7F00";
        break;
        case 2:
        ctx.fillStyle = "#FFFF00";
        break;
        case 3:
        ctx.fillStyle = "#8B00FF";
        break;
        case 4:
        ctx.fillStyle = "#8B8DFF";
        break;
        case 5:
        ctx.fillStyle = "#FBF8FD";
        break;
      }
      if (enemy_DNA.shape[enemy.type[i]]==0) {
        ctx.arc(enemy.x[i],enemy.y[i],enemy_DNA.size[enemy.type[i]],0,2*Math.PI);
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#000000';
      }
      ctx.stroke();
    }
  }
  function MoveEnemy(){
    for (var i = 0; i < enemy.D.length; i++) {
      if (enemy.hp[i]<=0) {
        money+=enemy.cost[i];
        POP+=enemy.cost[i];
        enemy.hp.splice(i,1);
        enemy.D.splice(i,1);
        enemy.point.splice(i,1);
        enemy.point_Saver.splice(i,1);
        enemy.type.splice(i,1);
        enemy.x.splice(i,1);
        enemy.y.splice(i,1);
        enemy.cost.splice(i,1);
      }else{
        enemy.x[i]+=Math.cos(Math.PI/180*(enemy.D[i]-90))*(enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod);
        enemy.y[i]+=Math.sin(Math.PI/180*(enemy.D[i]-90))*(enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod); //여기부터
        enemy.point[i]+=enemy_DNA.speed[enemy.type[i]]+enemy_DNA.speed[enemy.type[i]]*fastmod;
        if (map.point[enemy.point_Saver[i]]+20<=enemy.point[i]){
          if (map.point[enemy.point_Saver[i]]+20!=enemy.point[i]) {
            enemy.x[i]=map.pointLocationSaver[enemy.point_Saver[i]+1][0];
            enemy.y[i]=map.pointLocationSaver[enemy.point_Saver[i]+1][1];
          }
          enemy.point_Saver[i]+=1;
          enemy.D[i]=map.Devent[enemy.point_Saver[i]];
          enemy.point[i]=0;
          if (enemy.point_Saver[i]==map.point.length) {
            if (Difficulty!=4) {
              HP-=enemy.hp[i];
            }
            enemy.hp.splice(i,1);
            enemy.D.splice(i,1);
            enemy.point.splice(i,1);
            enemy.point_Saver.splice(i,1);
            enemy.type.splice(i,1);
            enemy.x.splice(i,1);
            enemy.y.splice(i,1);
            enemy.cost.splice(i,1);
          }
        }
      }
    }
  }
  function MakeEnemy(type){
    enemy.hp.push(enemy_DNA.hp[type]);
    enemy.cost.push(enemy_DNA.cost[type]);
    enemy.D.push(90);
    enemy.point.push(0);
    enemy.point_Saver.push(0);
    enemy.type.push(type);
    enemy.x.push(0);
    enemy.y.push(map.start);
  }
  function DrawTap(mod){
    var canvas = document.getElementById("MAIN");
    var ctx = document.getElementById("MAIN").getContext("2d");
    if (mod==-1) {
      ctx.beginPath();
      ctx.fillStyle="#964B00";
      ctx.fillRect(canvas.width*3/4,0,canvas.width,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth=5;
      ctx.strokeStyle="#000000";
      ctx.moveTo(canvas.width*3/4,0);
      ctx.lineTo(canvas.width*3/4,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*1/16);
      ctx.lineTo(canvas.width,canvas.height*1/16);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*2/16+5);
      ctx.lineTo(canvas.width,canvas.height*2/16+5);
      ctx.stroke();
      ctx.beginPath();
      ctx.fillStyle="#FFFFFF";
      ctx.fillRect(canvas.width*3/4+2.5,canvas.height*14/16+5,canvas.width*1/4-2.5,canvas.height*2/16-5);
      ctx.stroke();
      if (OnRound==0){
        if (Round<Round_DNA.length) {
          ctx.beginPath();
          ctx.fillStyle="#00FF00";
          ctx.strokeStyle="#00FF00";
          ctx.lineWidth=1;
          ctx.moveTo(canvas.width*3/4+7.5,canvas.height*14/16+15);
          ctx.lineTo(canvas.width*3/4+7.5,canvas.height*14/16+70);
          ctx.lineTo(canvas.width*3/4+50,canvas.height*14/16+(15+70)/2);
          ctx.fill();
          ctx.stroke();
          ctx.strokeStyle="#000000";
          ctx.beginPath();
          ctx.font = "50px Arial";
          ctx.fillStyle = "#000000";
          ctx.textAlign = "left";
          ctx.fillText("START",canvas.width*3/4+50,canvas.height*14/16+55);
          ctx.stroke();
        }else{
          ctx.font = "50px Arial";
          ctx.fillStyle = "#000000";
          ctx.textAlign = "left";
          ctx.fillText("THE END",canvas.width*3/4+25,canvas.height*14/16+55);
          ctx.stroke();
        }
      }else if(fastmod==0){
        ctx.beginPath();
        ctx.font = "50px Arial";
        ctx.fillStyle = "#2DA0FF";
        ctx.textAlign = "left";
        ctx.fillText("X1",canvas.width*3/4+50,canvas.height*14/16+55);
        ctx.stroke();
      }else if(fastmod==1){
        ctx.beginPath();
        ctx.font = "50px Arial";
        ctx.fillStyle = "#2DA0FF";
        ctx.textAlign = "left";
        ctx.fillText("X2",canvas.width*3/4+50,canvas.height*14/16+55);
        ctx.stroke();
      }
      ctx.lineWidth=5;
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#60AF60";
      ctx.textAlign = "left";
      ctx.fillText("$"+money,canvas.width*3/4+2.5,30);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("HP : "+HP,canvas.width*3/4+2.5,canvas.height*2/16-5);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*14/16+5);
      ctx.lineTo(canvas.width,canvas.height*14/16+5);
      ctx.stroke();
      ctx.fillStyle="#FFFFFF";
      for (var i = 0; i < 6; i++) {
        ctx.beginPath();
        ctx.fillRect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
        ctx.stroke();
        ctx.beginPath();
        ctx.rect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
        ctx.stroke();
      }
      DrawTower(0,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*3/16,50,0);
      DrawTower(1,[0,0],canvas.width*3/4+canvas.width*1/8+canvas.width*3/64,canvas.width*3/16,50,0);
      DrawTower(2,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*9.75/32,50,0);
      DrawTower(3,[0,0],canvas.width*3/4+canvas.width*1/8+canvas.width*3/64,canvas.width*9.75/32,50,0);
      DrawTower(4,[0,0],canvas.width*3/4+canvas.width*1/16,canvas.width*9.5/22,50,0);
      ctx.fillStyle="rgba(0,0,0,0.5)";
      for (var i = 0; i < 6; i++) {
        if (tower_DNA.cost[i]>money) {
          ctx.beginPath();
          ctx.fillRect(canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64,canvas.width*(Math.floor(i/2)+1)/8+5,canvas.width*1/8-canvas.width*2/64,canvas.width*1/8-canvas.width*2/64);
          ctx.stroke();
        }
      }
    }else{
      ctx.beginPath();
      ctx.fillStyle="#964B00";
      ctx.fillRect(canvas.width*3/4,0,canvas.width,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth=5;
      ctx.strokeStyle="#000000";
      ctx.moveTo(canvas.width*3/4,0);
      ctx.lineTo(canvas.width*3/4,canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*1/16);
      ctx.lineTo(canvas.width,canvas.height*1/16);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(canvas.width*3/4,canvas.height*2/16+5);
      ctx.lineTo(canvas.width,canvas.height*2/16+5);
      ctx.stroke();
      ctx.fillStyle="#FFFFFF";
      ctx.beginPath();
      ctx.fillRect(canvas.width*3/4+2.5,canvas.height*2/16+7.5,canvas.width*1/4-2.5,canvas.height*14/16-7.5);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "50px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("Cancel",canvas.width*6/8,canvas.height*9/16+7.5);
      ctx.stroke();
      ctx.font = "50px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("[ESC]",canvas.width*6/8+10,canvas.height*10/16+7.5);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#60AF60";
      ctx.textAlign = "left";
      ctx.fillText("$"+money,canvas.width*3/4+2.5,30);
      ctx.stroke();
      ctx.beginPath();
      ctx.font = "30px Arial";
      ctx.fillStyle = "#FF0000";
      ctx.textAlign = "left";
      ctx.fillText("HP : "+HP,canvas.width*3/4+2.5,canvas.height*2/16-5);
      ctx.stroke();
    }
  }
  function collision(ox,oy,rx,ry,rs,or){
    if ((rx-rs-or<=ox&& ox<=rx+rs+or)&&(ry-rs-or<=oy&&oy<=ry+rs+or)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx-rs,ry+rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx+rs,ry+rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx-rs,ry-rs)) {
      return 1;
    }else if (IsPointInCircle(ox,oy,or,rx+rs,ry-rs)) {
      return 1;
    }
    return 0;
  }
  function Ccollision(ax,ay,bx,by,ar,br) {
    if (Math.sqrt((ax-bx)**2+(ay-by)**2)<=ar+br) {
      return 1;
    }
    return 0;
  }
  function TowerClick(){
    var canvas = document.getElementById("MAIN");
    var ctx = canvas.getContext("2d");
    Select=-1;
    for (var i = 0; i < 5; i++) {
      if (canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64+10<=mouse.x&& mouse.x<=canvas.width*3/4+canvas.width*(i%2)/8+canvas.width*((i+1)%2)/64+5+canvas.width*1/8-canvas.width*2/64 && canvas.width*(Math.floor(i/2)+1)/8+15<=mouse.y&&mouse.y<=canvas.width*(Math.floor(i/2)+1)/8+10+canvas.width*1/8-canvas.width*2/64) {
        ctx.beginPath();
        ctx.strokeStyle='rgba(0,0,0,0)';
        ctx.fillStyle='rgba(20,20,20,0,5)';
        ctx.fillRect(canvas.width*3/4-200,mouse.y-50,200,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#FFFFFF";
        ctx.textAlign = "left";
        ctx.fillText(tower_DNA.name[i],canvas.width*3/4-200,mouse.y-20);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#FFFFFF";
        ctx.textAlign = "left";
        ctx.fillText("$"+tower_DNA.cost[i],canvas.width*3/4-200,mouse.y+10);
        ctx.stroke();
        if(mouse.click&&tower_DNA.cost[i]<=money){
          Select=i;
          return;
        }
      }
    }
    if ((canvas.width*3/4+2.5<=mouse.x&& mouse.x<=canvas.width&&canvas.height*14/16+5<=mouse.y&&mouse.y<=canvas.height&&mouse.click&&Round<Round_DNA.length)||(SPACE&&Round<Round_DNA.length)) {
      if(OnRound==0){
        fastmod=0;
        OnRound=1;
        ONE=0;
        SPACE=0;
      }else if (fastmod==0) {
        fastmod=1;
        SPACE=0;
      }else if (fastmod==1) {
        fastmod=0;
        SPACE=0;
      }
    }
  }
  function MakeEffect(x,y,type,value) {
    switch (type) {
      case 0:
        effect.x.push(x);
        effect.y.push(y);
        effect.Fx.push(x);
        effect.Fy.push(y);
        effect.type.push(type);
        effect.value.push(value);
        effect.Delay.push(50);
        break;
      case 1:
        effect.x.push(x);
        effect.y.push(y);
        effect.Fx.push(x);
        effect.Fy.push(y);
        effect.type.push(type);
        effect.value.push(value);
        effect.Delay.push(50);
        break;
    }
  }
  function ActiveEffect() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    for (var i = 0; i < effect.x.length; i++) {
      switch (effect.type[i]) {
        case 0:
          ctx.beginPath();
          ctx.font = "20px Arial";
          ctx.fillStyle = "#60AF60";
          ctx.textAlign = "center";
          ctx.fillText("+$"+effect.value[i],effect.x[i],effect.y[i]-10);
          ctx.stroke();
          if (effect.Fy[i]-30<effect.y[i]) {
            effect.y[i]-=0.5;
          }else if (effect.Delay[i]>0) {
            effect.Delay[i]-=1;
          }else if(effect.Delay[i]<=0){
            effect.x.splice(i,1);
            effect.y.splice(i,1);
            effect.Fx.splice(i,1);
            effect.Fy.splice(i,1);
            effect.type.splice(i,1);
            effect.value.splice(i,1);
            effect.Delay.splice(i,1);
          }
          break;
        case 1:
          ctx.beginPath();
          ctx.font = "20px Arial";
          ctx.fillStyle = "rgba(128,0,0,1.0)";
          ctx.textAlign = "center";
          ctx.fillText("+$"+effect.value[i],effect.x[i],effect.y[i]+10);
          ctx.stroke();
          if (effect.Fy[i]-30<effect.y[i]) {
            effect.y[i]-=0.5;
          }else if (effect.Delay[i]>0) {
            effect.Delay[i]-=1;
          }else if(effect.Delay[i]<=0){
            effect.x.splice(i,1);
            effect.y.splice(i,1);
            effect.Fx.splice(i,1);
            effect.Fy.splice(i,1);
            effect.type.splice(i,1);
            effect.value.splice(i,1);
            effect.Delay.splice(i,1);
          }
          break;
      }
    }
  }
  function Rcollision(Rect1,Rect2){ //[x1,y1,x2,y2]
    AR={
      L : Rect1[0]*(Rect1[0]<=Rect1[2])+Rect1[2]*(Rect1[0]>Rect1[2]),
      R : Rect1[2]*(Rect1[0]<=Rect1[2])+Rect1[0]*(Rect1[0]>Rect1[2]),
      U : Rect1[1]*(Rect1[1]<=Rect1[3])+Rect1[3]*(Rect1[1]>Rect1[3]),
      D : Rect1[3]*(Rect1[1]<=Rect1[3])+Rect1[1]*(Rect1[1]>Rect1[3])
    }
    BR={
      L : Rect2[0]*(Rect2[0]<=Rect2[2])+Rect2[2]*(Rect2[0]>Rect2[2]),
      R : Rect2[2]*(Rect2[0]<=Rect2[2])+Rect2[0]*(Rect2[0]>Rect2[2]),
      U : Rect2[1]*(Rect2[1]<=Rect2[3])+Rect2[3]*(Rect2[1]>Rect2[3]),
      D : Rect2[3]*(Rect2[1]<=Rect2[3])+Rect2[1]*(Rect2[1]>Rect2[3])
    }
    if (AR.L<=BR.R&&AR.U<=BR.D&&AR.R>=BR.L&&AR.D>=BR.U) {
      return 1;
    }
    return 0;
  }
  function IsPointInCircle(ox,oy,or,px,py){
    return Math.sqrt((ox-px)**2+(oy-py)**2)<=or;
  }
  function Rand(mod,max,min) {
    if(mod==0){
      return Math.random()*(max+1-min)+min;
    }else{
      return Math.floor(Math.random()*(max+1-min)+min);
    }
  }
  function DrawGear(D,x,y,size,mod) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    if (mod==1||mod==undefined) {
      DrawGear(D,x,y,size,0)
    }
    ctx.strokeStyle='rgba(0,0,0,0)';
    if (mod==1||mod==undefined) {
      ctx.fillStyle='#808080';
    }else{
      ctx.fillStyle='#404040';
    }
    ctx.beginPath();
    ctx.arc(x,y,size/2.5-(mod||mod==undefined)*size/40,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    if (mod==1||mod==undefined) {
      ctx.strokeStyle='#808080';
    }else{
      ctx.strokeStyle='#404040';
    }
    ctx.lineWidth=size/4-(mod||mod==undefined)*2*size/40;
    for (var i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(move(D-45*i,x,y,size/2-(mod||mod==undefined)*size/40)[0],move(D-45*i,x,y,size/2-(mod||mod==undefined)*size/40)[1]);
      ctx.stroke();
    }
    ctx.strokeStyle='rgba(0,0,0,0)';
    ctx.fillStyle='#404040';
    ctx.beginPath();
    ctx.arc(x,y,size/6,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
  }
  function DrawTowerTap(select) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.beginPath();
    ctx.lineWidth=5;
    ctx.fillStyle="#964B00";
    ctx.fillRect(80,450,600,200);
    ctx.stroke();
    ctx.beginPath();
    ctx.strokeStyle="#202020";
    ctx.rect(80,450,600,200);
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#D00000";
    ctx.rect(80,600,200,50);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "30px Arial";
    ctx.fillStyle = "#202020";
    ctx.textAlign = "center";
    ctx.fillText(tower_DNA.name[tower.type[select]],180,485);
    ctx.stroke();
    DrawTower(tower.type[select],tower.Upgrade[select],180,560,60,0);
    ctx.lineWidth=5;
    if(select!=-1){
      if(tower.Upgrade[select][0]!=2){
        ctx.beginPath();
        if(Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2]<=money){
          ctx.fillStyle="#00D000";
        }else{
          ctx.fillStyle="#808080";
        }
        ctx.strokeStyle="#202020";
        ctx.rect(280,600,200,50);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        ctx.fillText(Upgrade.name[tower.type[select]][tower.Upgrade[select][0]*2],380,485);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if(TowerTapEvent!=2){
          ctx.fillText("Upgrade",380,637.5);
        }else {
          ctx.fillText("$"+Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2],380,637.5);
        }
        ctx.stroke();
        DrawTower(tower.type[select],[tower.Upgrade[select][0]+1,tower.Upgrade[select][1]],380,560,60,0);
        ctx.lineWidth=5;
      }else{
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.fillStyle="#D00000";
        ctx.rect(280,450,200,200);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("이 방향의 업그레이드는",380,485);
        ctx.fillText("모두 완료하였습니다.",380,520);
        ctx.stroke();
      }
      if(tower.Upgrade[select][1]!=2){
        ctx.strokeStyle="#202020";
        if(Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1]<=money){
          ctx.fillStyle="#00D000";
        }else{
          ctx.fillStyle="#808080";
        }
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.rect(480,600,200,50);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        ctx.fillText(Upgrade.name[tower.type[select]][tower.Upgrade[select][1]*2+1],580,485);
        ctx.stroke();
        ctx.beginPath();
        ctx.font = "30px Arial";
        ctx.fillStyle = "#202020";
        ctx.textAlign = "center";
        if(TowerTapEvent!=3){
          ctx.fillText("Upgrade",580,637.5);
        }else {
          ctx.fillText("$"+Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1],580,637.5);
        }
        ctx.stroke();
        DrawTower(tower.type[select],[tower.Upgrade[select][0],tower.Upgrade[select][1]+1],580,560,60,0);
        ctx.lineWidth=5;
      }else{
        ctx.beginPath();
        ctx.strokeStyle="#202020";
        ctx.fillStyle="#D00000";
        ctx.rect(480,450,200,200);
        ctx.lineWidth=5;
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.fillStyle = "#FFFFFF";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("이 방향의 업그레이드는",580,485);
        ctx.fillText("모두 완료하였습니다.",580,520);
        ctx.stroke();
      }
    }
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.moveTo(280,450);
    ctx.lineTo(280,650);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "30px Arial";
    ctx.fillStyle = "#202020";
    ctx.textAlign = "center";
    if(TowerTapEvent!=1){
      ctx.fillText("판매",180,637.5);
    }else {
      ctx.fillText("+$"+tower.cost[select]*7/10,180,637.5);
    }
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(480,450);
    ctx.lineTo(480,650);
    ctx.stroke();
  }
  function TowerTapClick(select) {
    temp=mouse;
    TowerTapEvent=0;
    if (90<=mouse.x&&mouse.x<=285&&mouse.y>=595) {
      TowerTapEvent=1;
      if (mouse.click) {
        money+=tower.cost[select]*7/10;
        tower.x.splice(select,1);
        tower.y.splice(select,1);
        tower.type.splice(select,1);
        tower.Upgrade.splice(select,1);
        tower.R.splice(select,1);
        tower.D.splice(select,1);
        tower.AddBhp.splice(select,1);
        tower.AddADelay.splice(select,1);
        tower.AttackDelay.splice(select,1);
        tower.AddSpeed.splice(select,1);
        tower.cost.splice(select,1);
        SelectedTower=-1;
      }
    }else if (290<=mouse.x&&mouse.x<=485&&mouse.y>=595&&tower.Upgrade[select][0]!=2) {
      TowerTapEvent=2;
      if (mouse.click&&Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2]<=money) {
        if (typeof(Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2])=="number") {
          switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2]) {
            case 0:
              tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 1:
              tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 2:
              tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
            case 3:
              tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2];
              break;
          }
        }else{
          for (var i = 0; i < Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2].length; i++) {
            switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][0]*2][i]) { //0:bullet_hp,1:delay,2:Range,3:special
              case 0:
                tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 1:
                tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 2:
                tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
              case 3:
                tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][0]*2][i];
                break;
            }
          }
        }
        tower.cost[select]+=Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2];
        money-=Upgrade.cost[tower.type[select]][tower.Upgrade[select][0]*2];
        tower.Upgrade[select][0]+=1;
      }
    }else if (490<=mouse.x&&mouse.x<=685&&mouse.y>=595&&tower.Upgrade[select][1]!=2) {
      TowerTapEvent=3;
      if (mouse.click&&Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1]<=money) {
        if (typeof(Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1])=="number") {
          switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1]) {
            case 0:
              tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 1:
              tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 2:
              tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
            case 3:
              tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1];
              break;
          }
        }else{
          for (var i = 0; i < Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1].length; i++) {
            switch (Upgrade.AbilityTarget[tower.type[select]][tower.Upgrade[select][1]*2+1][i]) { //0:bullet_hp,1:delay,2:Range,3:special
              case 0:
                tower.AddBhp[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 1:
                tower.AddADelay[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 2:
                tower.R[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
              case 3:
                tower.AddSpeed[select]+=Upgrade.AbilityValue[tower.type[select]][tower.Upgrade[select][1]*2+1][i];
                break;
            }
          }
        }
        tower.cost[select]+=Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1];
        money-=Upgrade.cost[tower.type[select]][tower.Upgrade[select][1]*2+1];
        tower.Upgrade[select][1]+=1;
      }
    }
  }
  function MakeBullet(D,x,y,size,hp,speed) {
    bullet.hp.push(hp);
    bullet.x.push(x);
    bullet.y.push(y);
    bullet.D.push(D);
    bullet.type.push(-1);
    bullet.TargetLocation.push([0,0]);
    bullet.target.push(0);
    bullet.speed.push(speed);
    bullet.size.push(size);
    bullet.master.push(-1);
    bullet.upgrade.push([2,2]);
    bullet.temp.push(0);
  }
  function DifficultyList() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    ctx.lineWidth=2;
    ctx.fillStyle="#00FF00";
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.rect(25,100,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#FF8F00";
    ctx.rect(325,100,350,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#FF0000";
    ctx.rect(725,100,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#800000";
    ctx.rect(25,300,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#DEB887";
    ctx.rect(325,300,350,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.fillStyle="#808080";
    ctx.rect(725,300,250,150);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("쉬움",25+125,100+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("보통",325+175,100+75+30);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "75px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("어려움",725+125,100+75+30);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("지옥",25+125,300+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("샌드박스",325+175,300+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "100px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("∞",725+125,300+100);
    ctx.stroke();
    ctx.beginPath();
    ctx.font = "80px Arial";
    ctx.fillStyle = "#000000";
    ctx.textAlign = "center";
    ctx.fillText("<난이도&모드 선택>",500,75);
    ctx.stroke();
    if (25<=mouse.x&&mouse.x<=25+250&&100<=mouse.y&&mouse.y<=100+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(25,100,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=0;
        HP=125;
        for (var i = 0; i < tower_DNA.C.length; i++) {
          tower_DNA.cost[i]=tower_DNA.C[i]*0.75;
        }
        for (var i = 0; i < Upgrade.C.length; i++) {
          for (var j = 0; j < Upgrade.C[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.C[i][j]*0.75;
          }
        }
        Situation=3;
      }
    }else if(325<=mouse.x&&mouse.x<=325+350&&100<=mouse.y&&mouse.y<=100+150){
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(325,100,350,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=1;
        Situation=3;
      }
    }else if (725<=mouse.x&&mouse.x<=725+250&&100<=mouse.y&&mouse.y<=100+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(725,100,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        HP=75;
        Difficulty=2;
        for (var i = 0; i < tower_DNA.cost.length; i++) {
          tower_DNA.cost[i]=tower_DNA.cost[i]*1.25;
        }
        for (var i = 0; i < Upgrade.cost.length; i++) {
          for (var j = 0; j < Upgrade.cost[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.cost[i][j]*1.25;
          }
        }
        Situation=3;
      }
    }else if (25<=mouse.x&&mouse.x<=25+250&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(25,300,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        HP=10;
        Difficulty=3;
        for (var i = 0; i < tower_DNA.cost.length; i++) {
          tower_DNA.cost[i]=tower_DNA.cost[i]*1.5;
        }
        for (var i = 0; i < Upgrade.cost.length; i++) {
          for (var j = 0; j < Upgrade.cost[i].length; j++) {
            Upgrade.cost[i][j]=Upgrade.cost[i][j]*1.5;
          }
        }
        Situation=3;
      }
    }else if (325<=mouse.x&&mouse.x<=325+350&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(325,300,350,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=4;
        for (var i = 0; i < tower_DNA.cost.length; i++) {
          tower_DNA.cost[i]=0;
        }
        for (var i = 0; i < Upgrade.cost.length; i++) {
          for (var j = 0; j < Upgrade.cost[i].length; j++) {
            Upgrade.cost[i][j]=0;
          }
        }
        Situation=3;
      }
    }else if (725<=mouse.x&&mouse.x<=725+250&&300<=mouse.y&&mouse.y<=300+150) {
      ctx.beginPath();
      ctx.fillStyle="rgba(255,255,255,0.5)";
      ctx.rect(725,300,250,150);
      ctx.fill();
      ctx.stroke();
      if (mouse.click) {
        Difficulty=5;
        Situation=3;
      }
    }
  }
  function MapList() {
    var ctx = document.getElementById("MAIN").getContext("2d");
    if(page==Math.ceil(map_DNA.point.length/4)-1){
      for (var i = 4*page; i < 4*page+map_DNA.point.length%4; i++) {
        DrawMiniMap(50+450*(i%2)+12,25+275*(Math.floor((i%4)/2))-28,50,(i%4));
        ctx.fillStyle="#62911A";
        ctx.beginPath();
        ctx.fillRect(0,0,1000,24);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,276,1000,23);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,551,1000,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,0,49,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(451,0,48,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(450+62+400,0,50,650);
        ctx.stroke();
        ctx.lineWidth=2;
        ctx.strokeStyle="#202020";
        ctx.beginPath();
        ctx.rect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
        ctx.stroke();
        if (50+450*(i%2)<=mouse.x&&mouse.x<=450+450*(i%2)&&25+275*(Math.floor((i%4)/2))<=mouse.y&&mouse.y<=275+275*(Math.floor((i%4)/2))) {
          ctx.fillStyle="rgba(255,255,255,0.5)";
          ctx.beginPath();
          ctx.fillRect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
          ctx.stroke();
          if(mouse.click){
            Situation=1;
            map.start=map_DNA.start[i];
            map.point=[];
            map.Devent=[];
            for (var j = 0; j < map_DNA.point[i].length; j++) {
              map.point.push(map_DNA.point[i][j]);
              map.Devent.push(map_DNA.Devent[i][j]);
            }
          }
        }
      }
    }else {
      for (var i = 4*page; i < 4*page+4; i++) {
        DrawMiniMap(62+450*(i%2),275*(Math.floor((i%4)/2))-3,50,(i%4));
        ctx.fillStyle="#62911A";
        ctx.beginPath();
        ctx.fillRect(0,0,1000,24);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,276,1000,23);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,551,1000,100);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(0,0,49,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(451,0,48,650);
        ctx.stroke();
        ctx.beginPath();
        ctx.fillRect(450+62+400,0,50,650);
        ctx.stroke();
        ctx.lineWidth=2;
        ctx.strokeStyle="#202020";
        ctx.beginPath();
        ctx.rect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
        ctx.stroke();
        if (50+450*(i%2)<=mouse.x&&mouse.x<=450+450*(i%2)&&25+275*(Math.floor((i%4)/2))<=mouse.y&&mouse.y<=275+275*(Math.floor((i%4)/2))) {
          ctx.fillStyle="rgba(255,255,255,0.5)";
          ctx.beginPath();
          ctx.fillRect(50+450*(i%2),25+275*(Math.floor((i%4)/2)),400,250);
          ctx.stroke();
          if(mouse.click){
            Situation=1;
            map.start=map_DNA.start[i];
            map.point=[];
            map.Devent=[];
            for (var j = 0; j < map_DNA.point[i].length; j++) {
              map.point.push(map_DNA.point[i][j]);
              map.Devent.push(map_DNA.Devent[i][j]);
            }
          }
        }
      }
    }
    ctx.strokeStyle="#202020";
    ctx.fillStyle="#FFFFFF";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.rect(25,575,100,50);
    ctx.fill();
    ctx.stroke();
    arrow(80,600,50,270);
    for (var i = 0; i <Math.ceil(map_DNA.point.length/4); i++) {
      if (page==i) {
        ctx.beginPath();
        ctx.strokeStyle='rgba(0,0,0,0)';
        ctx.fillStyle="#00DEDF";
        ctx.arc(150+i*50,615,20,0,Math.PI*2);
        ctx.fill();
        ctx.stroke();
      }
      ctx.beginPath();
      ctx.font = "20px Arial";
      ctx.fillStyle = "#000000";
      ctx.textAlign = "center";
      ctx.fillText((i+1)+"",150+50*i,620);
      ctx.stroke();
      if (IsPointInCircle(150+i*50,615,20,mouse.x,mouse.y)&&mouse.click) {
        page=i;
      }
    }
    if (mouse.click&&25<=mouse.x&&mouse.x<=125&&575<=mouse.y&&mouse.y<=625) {
      Situation=2;
    }
  }
  function DrawMiniMap(x,y,size,MapType) {
    var ctx = document.getElementById("MAIN").getContext("2d");
    drawer={
      direction:90,
      x:x,
      y:y+map_DNA.start[MapType]*size/100
    };
    ctx.lineWidth=40*size/100;
    ctx.strokeStyle="#868e96";
    ctx.beginPath();
    ctx.strokeStyle="#868e96";
    ctx.moveTo(x,drawer.y);
    ctx.stroke();
    map.pointLocationSaver=[];
    for (var i = 0; i < map_DNA.point[MapType].length; i++) {
      ctx.beginPath();
      drawer.direction=map_DNA.Devent[MapType][i];
      map.pointLocationSaver.push([drawer.x,drawer.y]);
      if(drawer.direction==0){
        ctx.moveTo(drawer.x,drawer.y+ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y-ctx.lineWidth/2+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else if (drawer.direction==90) {
        ctx.moveTo(drawer.x-ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x+ctx.lineWidth/2+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else if (drawer.direction==180) {
        ctx.moveTo(drawer.x,drawer.y-ctx.lineWidth/2);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+ctx.lineWidth/2+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else if (drawer.direction==270) {
        ctx.moveTo(drawer.x+ctx.lineWidth/2,drawer.y);
        drawer.x=drawer.x-ctx.lineWidth/2+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }else{
        ctx.moveTo(drawer.x,drawer.y);
        drawer.x=drawer.x+Math.cos(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
        drawer.y=drawer.y+Math.sin(Math.PI/180*(map_DNA.Devent[MapType][i]-90))*map_DNA.point[MapType][i]*size/100;
      }
      ctx.lineTo(drawer.x,drawer.y);
      ctx.stroke();
    }
    map.pointLocationSaver.push([drawer.x,drawer.y]);
  }
  function arrow(x,y,size,direction){
    var ctx = document.getElementById("MAIN").getContext("2d");
    M=size/50;
    ctx.fillStyle="#FF0000";
    ctx.strokeStyle="#202020";
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+90,move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1],10*M)[0],move(direction+90,move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1],10*M)[1]);
    ctx.lineTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.lineTo(move(direction-90,move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1],10*M)[0],move(direction-90,move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1],10*M)[1]);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction+180,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.strokeStyle='rgba(0,0,0,0)';
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(move(direction,x,y,40*M)[0],move(direction,x,y,40*M)[1]);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[0],move(direction,move(direction+90,x,y,10*M)[0],move(direction+90,x,y,10*M)[1],20*M)[1]);
    ctx.lineTo(x,y);
    ctx.lineTo(move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[0],move(direction,move(direction-90,x,y,10*M)[0],move(direction-90,x,y,10*M)[1],20*M)[1]);
    ctx.fill();
    ctx.stroke();
  }
  </script>
</head>
<body onload="draw()">
  <canvas id="MAIN" width="1000" height="650"></canvas>
</body>
</html>
